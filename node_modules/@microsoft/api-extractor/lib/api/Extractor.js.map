{"version":3,"file":"Extractor.js","sourceRoot":"","sources":["../../src/api/Extractor.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\r\n// See LICENSE in the project root for license information.\r\n\r\nimport * as path from 'path';\r\nimport * as ts from 'typescript';\r\nimport * as resolve from 'resolve';\r\nimport lodash = require('lodash');\r\nimport colors = require('colors');\r\n\r\nimport {\r\n  JsonFile,\r\n  JsonSchema,\r\n  Path,\r\n  FileSystem,\r\n  IPackageJson,\r\n  NewlineKind,\r\n  PackageJsonLookup\r\n} from '@microsoft/node-core-library';\r\nimport {\r\n  IExtractorConfig,\r\n  IExtractorProjectConfig,\r\n  IExtractorDtsRollupConfig,\r\n  IExtractorApiJsonFileConfig\r\n} from './IExtractorConfig';\r\nimport { ILogger } from './ILogger';\r\nimport { Collector } from '../collector/Collector';\r\nimport { DtsRollupGenerator, DtsRollupKind } from '../generators/DtsRollupGenerator';\r\nimport { MonitoredLogger } from './MonitoredLogger';\r\nimport { TypeScriptMessageFormatter } from '../analyzer/TypeScriptMessageFormatter';\r\nimport { ApiModelGenerator } from '../generators/ApiModelGenerator';\r\nimport { ApiPackage } from './model/ApiPackage';\r\nimport { ReviewFileGenerator } from '../generators/ReviewFileGenerator';\r\nimport { PackageMetadataManager } from '../analyzer/PackageMetadataManager';\r\n\r\n/**\r\n * Options for {@link Extractor.processProject}.\r\n * @public\r\n */\r\nexport interface IAnalyzeProjectOptions {\r\n  /**\r\n   * If omitted, then the {@link IExtractorConfig.project} config will be used by default.\r\n   */\r\n  projectConfig?: IExtractorProjectConfig;\r\n}\r\n\r\n/**\r\n * Runtime options for Extractor.\r\n *\r\n * @public\r\n */\r\nexport interface IExtractorOptions {\r\n  /**\r\n   * If IExtractorConfig.project.configType = 'runtime', then the TypeScript compiler state\r\n   * must be provided via this option.\r\n   */\r\n  compilerProgram?: ts.Program;\r\n\r\n  /**\r\n   * Allows the caller to handle API Extractor errors; otherwise, they will be logged\r\n   * to the console.\r\n   */\r\n  customLogger?: Partial<ILogger>;\r\n\r\n  /**\r\n   * Indicates that API Extractor is running as part of a local build, e.g. on developer's\r\n   * machine. This disables certain validation that would normally be performed\r\n   * for a ship/production build. For example, the *.api.ts review file is\r\n   * automatically local in a debug build.\r\n   *\r\n   * The default value is false.\r\n   */\r\n  localBuild?: boolean;\r\n\r\n  /**\r\n   * By default API Extractor uses its own TypeScript compiler version to analyze your project.\r\n   * This can often cause compiler errors due to incompatibilities between different TS versions.\r\n   * Use this option to specify the folder path for your compiler version.\r\n   *\r\n   * @remarks\r\n   * This option only applies when compiler.config.configType is set to \"tsconfig\"\r\n   *\r\n   * @beta\r\n   */\r\n  typescriptCompilerFolder?: string;\r\n\r\n  /**\r\n   * This option causes the typechecker to be invoked with the --skipLibCheck option. This option is not\r\n   * recommended and may cause API Extractor to produce incomplete or incorrect declarations, but it\r\n   * may be required when dependencies contain declarations that are incompatible with the TypeScript engine\r\n   * that API Extractor uses for its analysis. If this option is used, it is strongly recommended that broken\r\n   * dependencies be fixed or upgraded.\r\n   *\r\n   * @remarks\r\n   * This option only applies when compiler.config.configType is set to \"tsconfig\"\r\n   */\r\n  skipLibCheck?: boolean;\r\n}\r\n\r\n/**\r\n * Used to invoke the API Extractor tool.\r\n * @public\r\n */\r\nexport class Extractor {\r\n  /**\r\n   * The JSON Schema for API Extractor config file (api-extractor-config.schema.json).\r\n   */\r\n  public static jsonSchema: JsonSchema = JsonSchema.fromFile(\r\n    path.join(__dirname, '../schemas/api-extractor.schema.json'));\r\n\r\n  /**\r\n   * Returns the version number of the API Extractor NPM package.\r\n   */\r\n  public static get version(): string {\r\n    return Extractor._getPackageJson().version;\r\n  }\r\n\r\n  /**\r\n   * Returns the package name of the API Extractor NPM package.\r\n   */\r\n  public static get packageName(): string {\r\n    return Extractor._getPackageJson().name;\r\n  }\r\n\r\n  private static _getPackageJson(): IPackageJson {\r\n    return PackageJsonLookup.loadOwnPackageJson(__dirname);\r\n  }\r\n\r\n  private static _defaultConfig: Partial<IExtractorConfig> = JsonFile.load(path.join(__dirname,\r\n    '../schemas/api-extractor-defaults.json'));\r\n\r\n  private static _declarationFileExtensionRegExp: RegExp = /\\.d\\.ts$/i;\r\n\r\n  private static _defaultLogger: ILogger = {\r\n    logVerbose: (message: string) => console.log('(Verbose) ' + message),\r\n    logInfo: (message: string) => console.log(message),\r\n    logWarning: (message: string) => console.warn(colors.yellow(message)),\r\n    logError: (message: string) => console.error(colors.red(message))\r\n  };\r\n\r\n  private readonly _actualConfig: IExtractorConfig;\r\n  private readonly _program: ts.Program;\r\n  private readonly _localBuild: boolean;\r\n  private readonly _monitoredLogger: MonitoredLogger;\r\n  private readonly _absoluteRootFolder: string;\r\n\r\n  /**\r\n   * Given a list of absolute file paths, return a list containing only the declaration\r\n   * files.  Duplicates are also eliminated.\r\n   *\r\n   * @remarks\r\n   * The tsconfig.json settings specify the compiler's input (a set of *.ts source files,\r\n   * plus some *.d.ts declaration files used for legacy typings).  However API Extractor\r\n   * analyzes the compiler's output (a set of *.d.ts entry point files, plus any legacy\r\n   * typings).  This requires API Extractor to generate a special file list when it invokes\r\n   * the compiler.\r\n   *\r\n   * For configType=tsconfig this happens automatically, but for configType=runtime it is\r\n   * the responsibility of the custom tooling.  The generateFilePathsForAnalysis() function\r\n   * is provided to facilitate that.  Duplicates are removed so that entry points can be\r\n   * appended without worrying whether they may already appear in the tsconfig.json file list.\r\n   */\r\n  public static generateFilePathsForAnalysis(inputFilePaths: string[]): string[] {\r\n    const analysisFilePaths: string[] = [];\r\n\r\n    const seenFiles: Set<string> = new Set<string>();\r\n\r\n    for (const inputFilePath of inputFilePaths) {\r\n      const inputFileToUpper: string = inputFilePath.toUpperCase();\r\n      if (!seenFiles.has(inputFileToUpper)) {\r\n        seenFiles.add(inputFileToUpper);\r\n\r\n        if (!path.isAbsolute(inputFilePath)) {\r\n          throw new Error('Input file is not an absolute path: ' + inputFilePath);\r\n        }\r\n\r\n        if (Extractor._declarationFileExtensionRegExp.test(inputFilePath)) {\r\n          analysisFilePaths.push(inputFilePath);\r\n        }\r\n      }\r\n    }\r\n\r\n    return analysisFilePaths;\r\n  }\r\n\r\n  /**\r\n   * Invokes the API Extractor engine, using the api extractor configuration file.\r\n   * @param jsonConfigFile - Path to api extractor json config file.\r\n   * @param options - IExtractor options.\r\n   */\r\n  public static processProjectFromConfigFile(jsonConfigFile: string, options?: IExtractorOptions): void {\r\n    const configObject: IExtractorConfig = this.loadConfigObject(jsonConfigFile);\r\n    const extractor: Extractor = new Extractor(configObject, options);\r\n    extractor.processProject();\r\n  }\r\n\r\n  /**\r\n   * Loads the api extractor config file in Extractor Config object.\r\n   * The jsonConfigFile path specified is relative to project directory path.\r\n   * @param jsonConfigFile - Path to api extractor json config file.\r\n   */\r\n  public static loadConfigObject(jsonConfigFile: string): IExtractorConfig {\r\n    // Set to keep track of config files which have been processed.\r\n    const pathSet: Set<string> = new Set<string>();\r\n    // Get absolute path of config file.\r\n    let currentConfigFilePath: string = path.resolve(process.cwd(), jsonConfigFile);\r\n    pathSet.add(currentConfigFilePath);\r\n\r\n    const originalConfigFileFolder: string = path.dirname(currentConfigFilePath);\r\n\r\n    let extractorConfig: IExtractorConfig = JsonFile.load(jsonConfigFile);\r\n\r\n    while (extractorConfig.extends) {\r\n      if (extractorConfig.extends.match(/^\\./)) {\r\n        // If extends has relative path.\r\n        // Populate the api extractor config path defined in extends relative to current config path.\r\n        currentConfigFilePath = path.resolve(originalConfigFileFolder, extractorConfig.extends);\r\n      } else {\r\n        // If extends has package path.\r\n        currentConfigFilePath = resolve.sync(\r\n          extractorConfig.extends,\r\n          {\r\n            basedir: originalConfigFileFolder\r\n          }\r\n        );\r\n      }\r\n      // Check if this file was already processed.\r\n      if (pathSet.has(currentConfigFilePath)) {\r\n        throw new Error(`The API Extractor config files contain a cycle. \"${currentConfigFilePath}\"`\r\n          + ` is included twice.  Please check the \"extends\" values in config files.`);\r\n      }\r\n      pathSet.add(currentConfigFilePath);\r\n\r\n      // Remove extends property from config for current config.\r\n      delete extractorConfig.extends;\r\n\r\n      // Load the extractor config defined in extends property.\r\n      const baseConfig: IExtractorConfig = JsonFile.load(currentConfigFilePath);\r\n      lodash.merge(baseConfig, extractorConfig);\r\n      extractorConfig = baseConfig;\r\n    }\r\n\r\n    // Validate if the extractor config generated adheres to schema.\r\n    Extractor.jsonSchema.validateObject(extractorConfig, jsonConfigFile);\r\n    return extractorConfig;\r\n  }\r\n\r\n  private static _applyConfigDefaults(config: IExtractorConfig): IExtractorConfig {\r\n    // Use the provided config to override the defaults\r\n    const normalized: IExtractorConfig  = lodash.merge(\r\n      lodash.cloneDeep(Extractor._defaultConfig), config);\r\n\r\n    return normalized;\r\n  }\r\n\r\n  public constructor(config: IExtractorConfig, options?: IExtractorOptions) {\r\n    let mergedLogger: ILogger;\r\n    if (options && options.customLogger) {\r\n      mergedLogger = lodash.merge(lodash.clone(Extractor._defaultLogger), options.customLogger);\r\n    } else {\r\n      mergedLogger = Extractor._defaultLogger;\r\n    }\r\n    this._monitoredLogger = new MonitoredLogger(mergedLogger);\r\n\r\n    this._actualConfig = Extractor._applyConfigDefaults(config);\r\n\r\n    if (!options) {\r\n      options = { };\r\n    }\r\n\r\n    this._localBuild = options.localBuild || false;\r\n\r\n    switch (this.actualConfig.compiler.configType) {\r\n      case 'tsconfig':\r\n        const rootFolder: string = this.actualConfig.compiler.rootFolder;\r\n        if (!FileSystem.exists(rootFolder)) {\r\n          throw new Error('The root folder does not exist: ' + rootFolder);\r\n        }\r\n\r\n        this._absoluteRootFolder = path.normalize(path.resolve(rootFolder));\r\n\r\n        let tsconfig: {} | undefined = this.actualConfig.compiler.overrideTsconfig;\r\n        if (!tsconfig) {\r\n          // If it wasn't overridden, then load it from disk\r\n          tsconfig = JsonFile.load(path.join(this._absoluteRootFolder, 'tsconfig.json'));\r\n        }\r\n\r\n        const commandLine: ts.ParsedCommandLine = ts.parseJsonConfigFileContent(\r\n          tsconfig,\r\n          ts.sys,\r\n          this._absoluteRootFolder\r\n        );\r\n\r\n        if (!commandLine.options.skipLibCheck && options.skipLibCheck) {\r\n          commandLine.options.skipLibCheck = true;\r\n          console.log(colors.cyan(\r\n            'API Extractor was invoked with skipLibCheck. This is not recommended and may cause ' +\r\n            'incorrect type analysis.'\r\n          ));\r\n        }\r\n\r\n        this._updateCommandLineForTypescriptPackage(commandLine, options);\r\n\r\n        const normalizedEntryPointFile: string = path.normalize(\r\n          path.resolve(this._absoluteRootFolder, this.actualConfig.project.entryPointSourceFile)\r\n        );\r\n\r\n        // Append the normalizedEntryPointFile and remove any non-declaration files from the list\r\n        const analysisFilePaths: string[] = Extractor.generateFilePathsForAnalysis(\r\n          commandLine.fileNames.concat(normalizedEntryPointFile)\r\n        );\r\n\r\n        this._program = ts.createProgram(analysisFilePaths, commandLine.options);\r\n\r\n        if (commandLine.errors.length > 0) {\r\n          const errorText: string = TypeScriptMessageFormatter.format(commandLine.errors[0].messageText);\r\n          throw new Error(`Error parsing tsconfig.json content: ${errorText}`);\r\n        }\r\n\r\n        break;\r\n\r\n      case 'runtime':\r\n        if (!options.compilerProgram) {\r\n          throw new Error('The compiler.configType=runtime configuration was specified,'\r\n            + ' but the caller did not provide an options.compilerProgram object');\r\n        }\r\n\r\n        this._program = options.compilerProgram;\r\n        const rootDir: string | undefined = this._program.getCompilerOptions().rootDir;\r\n        if (!rootDir) {\r\n          throw new Error('The provided compiler state does not specify a root folder');\r\n        }\r\n        if (!FileSystem.exists(rootDir)) {\r\n          throw new Error('The rootDir does not exist: ' + rootDir);\r\n        }\r\n        this._absoluteRootFolder = path.resolve(rootDir);\r\n        break;\r\n\r\n      default:\r\n        throw new Error('Unsupported config type');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns the normalized configuration object after defaults have been applied.\r\n   *\r\n   * @remarks\r\n   * This is a read-only object.  The caller should NOT modify any member of this object.\r\n   * It is provided for diagnostic purposes.  For example, a build script could write\r\n   * this object to a JSON file to report the final configuration options used by API Extractor.\r\n   */\r\n  public get actualConfig(): IExtractorConfig {\r\n    return this._actualConfig;\r\n  }\r\n\r\n  /**\r\n   * Invokes the API Extractor engine, using the configuration that was passed to the constructor.\r\n   * @deprecated Use {@link Extractor.processProject} instead.\r\n   */\r\n  public analyzeProject(options?: IAnalyzeProjectOptions): void {\r\n    this.processProject(options);\r\n  }\r\n\r\n  /**\r\n   * Invokes the API Extractor engine, using the configuration that was passed to the constructor.\r\n   * @param options - provides additional runtime state that is NOT part of the API Extractor\r\n   *     config file.\r\n   * @returns true for a successful build, or false if the tool chain should fail the build\r\n   *\r\n   * @remarks\r\n   *\r\n   * This function returns false to indicate that the build failed, i.e. the command-line tool\r\n   * would return a nonzero exit code.  Normally the build fails if there are any errors or\r\n   * warnings; however, if options.localBuild=true then warnings are ignored.\r\n   */\r\n  public processProject(options?: IAnalyzeProjectOptions): boolean {\r\n    this._monitoredLogger.resetCounters();\r\n\r\n    if (!options) {\r\n      options = { };\r\n    }\r\n\r\n    const projectConfig: IExtractorProjectConfig = options.projectConfig ?\r\n      options.projectConfig : this.actualConfig.project;\r\n\r\n    // This helps strict-null-checks to understand that _applyConfigDefaults() eliminated\r\n    // any undefined members\r\n    if (!(this.actualConfig.policies && this.actualConfig.validationRules\r\n      && this.actualConfig.apiJsonFile && this.actualConfig.apiReviewFile && this.actualConfig.dtsRollup)) {\r\n      throw new Error('The configuration object wasn\\'t normalized properly');\r\n    }\r\n\r\n    if (!Extractor._declarationFileExtensionRegExp.test(projectConfig.entryPointSourceFile)) {\r\n      throw new Error('The entry point is not a declaration file: ' + projectConfig.entryPointSourceFile);\r\n    }\r\n\r\n    const collector: Collector = new Collector({\r\n      program: this._program,\r\n      entryPointFile: path.resolve(this._absoluteRootFolder, projectConfig.entryPointSourceFile),\r\n      logger: this._monitoredLogger,\r\n      policies: this.actualConfig.policies,\r\n      validationRules: this.actualConfig.validationRules\r\n    });\r\n\r\n    collector.analyze();\r\n\r\n    const modelBuilder: ApiModelGenerator = new ApiModelGenerator(collector);\r\n    const apiPackage: ApiPackage = modelBuilder.buildApiPackage();\r\n\r\n    const packageBaseName: string = path.basename(collector.package.name);\r\n\r\n    const apiJsonFileConfig: IExtractorApiJsonFileConfig = this.actualConfig.apiJsonFile;\r\n\r\n    if (apiJsonFileConfig.enabled) {\r\n      const outputFolder: string = path.resolve(this._absoluteRootFolder, apiJsonFileConfig.outputFolder);\r\n\r\n      const apiJsonFilename: string = path.join(outputFolder, packageBaseName + '.api.json');\r\n\r\n      this._monitoredLogger.logVerbose('Writing: ' + apiJsonFilename);\r\n      apiPackage.saveToJsonFile(apiJsonFilename, {\r\n        newlineConversion: NewlineKind.CrLf,\r\n        ensureFolderExists: true\r\n      });\r\n    }\r\n\r\n    if (this.actualConfig.apiReviewFile.enabled) {\r\n      const apiReviewFilename: string = packageBaseName + '.api.ts';\r\n\r\n      const actualApiReviewPath: string = path.resolve(this._absoluteRootFolder,\r\n        this.actualConfig.apiReviewFile.tempFolder, apiReviewFilename);\r\n      const actualApiReviewShortPath: string = this._getShortFilePath(actualApiReviewPath);\r\n\r\n      const expectedApiReviewPath: string = path.resolve(this._absoluteRootFolder,\r\n        this.actualConfig.apiReviewFile.apiReviewFolder, apiReviewFilename);\r\n      const expectedApiReviewShortPath: string = this._getShortFilePath(expectedApiReviewPath);\r\n\r\n      const actualApiReviewContent: string = ReviewFileGenerator.generateReviewFileContent(collector);\r\n\r\n      // Write the actual file\r\n      FileSystem.writeFile(actualApiReviewPath, actualApiReviewContent, {\r\n        ensureFolderExists: true,\r\n        convertLineEndings: NewlineKind.CrLf\r\n      });\r\n\r\n      // Compare it against the expected file\r\n      if (FileSystem.exists(expectedApiReviewPath)) {\r\n        const expectedApiReviewContent: string = FileSystem.readFile(expectedApiReviewPath);\r\n\r\n        if (!ReviewFileGenerator.areEquivalentApiFileContents(actualApiReviewContent, expectedApiReviewContent)) {\r\n          if (!this._localBuild) {\r\n            // For production, issue a warning that will break the CI build.\r\n            this._monitoredLogger.logWarning('You have changed the public API signature for this project.'\r\n              // @microsoft/gulp-core-build seems to run JSON.stringify() on the error messages for some reason,\r\n              // so try to avoid escaped characters:\r\n              + ` Please overwrite ${expectedApiReviewShortPath} with a`\r\n              + ` copy of ${actualApiReviewShortPath}`\r\n              + ' and then request an API review. See the Git repository README.md for more info.');\r\n          } else {\r\n            // For a local build, just copy the file automatically.\r\n            this._monitoredLogger.logWarning('You have changed the public API signature for this project.'\r\n              + ` Updating ${expectedApiReviewShortPath}`);\r\n\r\n            FileSystem.writeFile(expectedApiReviewPath, actualApiReviewContent, {\r\n              ensureFolderExists: true,\r\n              convertLineEndings: NewlineKind.CrLf\r\n            });\r\n          }\r\n        } else {\r\n          this._monitoredLogger.logVerbose(`The API signature is up to date: ${actualApiReviewShortPath}`);\r\n        }\r\n      } else {\r\n        // NOTE: This warning seems like a nuisance, but it has caught genuine mistakes.\r\n        // For example, when projects were moved into category folders, the relative path for\r\n        // the API review files ended up in the wrong place.\r\n        this._monitoredLogger.logError(`The API review file has not been set up.`\r\n          + ` Do this by copying ${actualApiReviewShortPath}`\r\n          + ` to ${expectedApiReviewShortPath} and committing it.`);\r\n      }\r\n    }\r\n\r\n    this._generateRollupDtsFiles(collector);\r\n\r\n    // Write the tsdoc-metadata.json file for this project\r\n    PackageMetadataManager.writeTsdocMetadataFile(collector.package.packageFolder);\r\n\r\n    if (this._localBuild) {\r\n      // For a local build, fail if there were errors (but ignore warnings)\r\n      return this._monitoredLogger.errorCount === 0;\r\n    } else {\r\n      // For a production build, fail if there were any errors or warnings\r\n      return (this._monitoredLogger.errorCount + this._monitoredLogger.warningCount) === 0;\r\n    }\r\n  }\r\n\r\n  private _generateRollupDtsFiles(collector: Collector): void {\r\n    const packageFolder: string = collector.package.packageFolder;\r\n\r\n    const dtsRollup: IExtractorDtsRollupConfig = this.actualConfig.dtsRollup!;\r\n    if (dtsRollup.enabled) {\r\n      let mainDtsRollupPath: string = dtsRollup.mainDtsRollupPath!;\r\n\r\n      if (!mainDtsRollupPath) {\r\n        // If the mainDtsRollupPath is not specified, then infer it from the package.json file\r\n        if (!collector.package.packageJson.typings) {\r\n          this._monitoredLogger.logError('Either the \"mainDtsRollupPath\" setting must be specified,'\r\n            + ' or else the package.json file must contain a \"typings\" field.');\r\n          return;\r\n        }\r\n\r\n        // Resolve the \"typings\" field relative to package.json itself\r\n        const resolvedTypings: string = path.resolve(packageFolder, collector.package.packageJson.typings);\r\n\r\n        if (dtsRollup.trimming) {\r\n          if (!Path.isUnder(resolvedTypings, dtsRollup.publishFolderForInternal!)) {\r\n            this._monitoredLogger.logError('The \"mainDtsRollupPath\" setting was not specified.'\r\n              + ' In this case, the package.json \"typings\" field must point to a file under'\r\n              + ' the \"publishFolderForInternal\": ' + dtsRollup.publishFolderForInternal!);\r\n            return;\r\n          }\r\n\r\n          mainDtsRollupPath = path.relative(dtsRollup.publishFolderForInternal!, resolvedTypings);\r\n        } else {\r\n          if (!Path.isUnder(resolvedTypings, dtsRollup.publishFolder!)) {\r\n            this._monitoredLogger.logError('The \"mainDtsRollupPath\" setting was not specified.'\r\n              + ' In this case, the package.json \"typings\" field must point to a file under'\r\n              + ' the \"publishFolder\": ' + dtsRollup.publishFolder!);\r\n            return;\r\n          }\r\n\r\n          mainDtsRollupPath = path.relative(dtsRollup.publishFolder!, resolvedTypings);\r\n        }\r\n\r\n        this._monitoredLogger.logVerbose(\r\n          `The \"mainDtsRollupPath\" setting was inferred from package.json: ${mainDtsRollupPath}`\r\n        );\r\n      } else {\r\n        this._monitoredLogger.logVerbose(`The \"mainDtsRollupPath\" is: ${mainDtsRollupPath}`);\r\n\r\n        if (path.isAbsolute(mainDtsRollupPath)) {\r\n          this._monitoredLogger.logError('The \"mainDtsRollupPath\" setting must be a relative path'\r\n            + ' that can be combined with one of the \"publishFolder\" settings.');\r\n          return;\r\n        }\r\n      }\r\n\r\n      if (dtsRollup.trimming) {\r\n        this._generateRollupDtsFile(collector,\r\n          path.resolve(packageFolder, dtsRollup.publishFolderForPublic!, mainDtsRollupPath),\r\n          DtsRollupKind.PublicRelease);\r\n\r\n        this._generateRollupDtsFile(collector,\r\n          path.resolve(packageFolder, dtsRollup.publishFolderForBeta!, mainDtsRollupPath),\r\n          DtsRollupKind.BetaRelease);\r\n\r\n        this._generateRollupDtsFile(collector,\r\n          path.resolve(packageFolder, dtsRollup.publishFolderForInternal!, mainDtsRollupPath),\r\n          DtsRollupKind.InternalRelease);\r\n      } else {\r\n        this._generateRollupDtsFile(collector,\r\n          path.resolve(packageFolder, dtsRollup.publishFolder!, mainDtsRollupPath),\r\n          DtsRollupKind.InternalRelease); // (no trimming)\r\n      }\r\n    }\r\n  }\r\n\r\n  private _generateRollupDtsFile(collector: Collector, mainDtsRollupFullPath: string,\r\n    dtsKind: DtsRollupKind): void {\r\n\r\n    this._monitoredLogger.logVerbose(`Writing package typings: ${mainDtsRollupFullPath}`);\r\n\r\n    DtsRollupGenerator.writeTypingsFile(collector, mainDtsRollupFullPath, dtsKind);\r\n  }\r\n\r\n  // Returns a simplified file path for use in error messages\r\n  private _getShortFilePath(absolutePath: string): string {\r\n    if (!path.isAbsolute(absolutePath)) {\r\n      throw new Error('Expected absolute path: ' + absolutePath);\r\n    }\r\n    return path.relative(this._absoluteRootFolder, absolutePath).replace(/\\\\/g, '/');\r\n  }\r\n\r\n  /**\r\n   * Update the parsed command line to use paths from the specified TS compiler folder, if\r\n   * a TS compiler folder is specified.\r\n   */\r\n  private _updateCommandLineForTypescriptPackage(\r\n    commandLine: ts.ParsedCommandLine,\r\n    options: IExtractorOptions\r\n  ): void {\r\n    const DEFAULT_BUILTIN_LIBRARY: string = 'lib.d.ts';\r\n    const OTHER_BUILTIN_LIBRARIES: string[] = ['lib.es5.d.ts', 'lib.es6.d.ts'];\r\n\r\n    if (options.typescriptCompilerFolder) {\r\n      commandLine.options.noLib = true;\r\n      const compilerLibFolder: string = path.join(options.typescriptCompilerFolder, 'lib');\r\n\r\n      let foundBaseLib: boolean = false;\r\n      const filesToAdd: string[]  = [];\r\n      for (const libFilename of commandLine.options.lib || []) {\r\n        if (libFilename === DEFAULT_BUILTIN_LIBRARY) {\r\n          // Ignore the default lib - it'll get added later\r\n          continue;\r\n        }\r\n\r\n        if (OTHER_BUILTIN_LIBRARIES.indexOf(libFilename) !== -1) {\r\n          foundBaseLib = true;\r\n        }\r\n\r\n        const libPath: string = path.join(compilerLibFolder, libFilename);\r\n        if (!FileSystem.exists(libPath)) {\r\n          throw new Error(`lib ${libFilename} does not exist in the compiler specified in typescriptLibPackage`);\r\n        }\r\n\r\n        filesToAdd.push(libPath);\r\n      }\r\n\r\n      if (!foundBaseLib) {\r\n        // If we didn't find another version of the base lib library, include the default\r\n        filesToAdd.push(path.join(compilerLibFolder, 'lib.d.ts'));\r\n      }\r\n\r\n      if (!commandLine.fileNames) {\r\n        commandLine.fileNames = [];\r\n      }\r\n\r\n      commandLine.fileNames.push(...filesToAdd);\r\n\r\n      commandLine.options.lib = undefined;\r\n    }\r\n  }\r\n}\r\n"]}