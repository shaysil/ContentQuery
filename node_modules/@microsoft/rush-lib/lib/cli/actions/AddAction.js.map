{"version":3,"file":"AddAction.js","sourceRoot":"","sources":["../../../src/cli/actions/AddAction.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\r\n// See LICENSE in the project root for license information.\r\n\r\nimport * as os from 'os';\r\nimport * as semver from 'semver';\r\n\r\nimport {\r\n  CommandLineFlagParameter,\r\n  CommandLineStringParameter\r\n} from '@microsoft/ts-command-line';\r\n\r\nimport { RushConfigurationProject } from '../../api/RushConfigurationProject';\r\nimport { BaseRushAction } from './BaseRushAction';\r\nimport { RushCommandLineParser } from '../RushCommandLineParser';\r\nimport { PackageJsonUpdater, SemVerStyle } from '../../logic/PackageJsonUpdater';\r\nimport { PackageName } from '@microsoft/node-core-library';\r\n\r\nexport class AddAction extends BaseRushAction {\r\n  private _exactFlag: CommandLineFlagParameter;\r\n  private _caretFlag: CommandLineFlagParameter;\r\n  private _devDependencyFlag: CommandLineFlagParameter;\r\n  private _makeConsistentFlag: CommandLineFlagParameter;\r\n  private _skipUpdateFlag: CommandLineFlagParameter;\r\n  private _packageName: CommandLineStringParameter;\r\n\r\n  constructor(parser: RushCommandLineParser) {\r\n    const documentation: string[] = [\r\n      'Adds a specified package as a dependency of the current project (as determined by the current working directory)'\r\n      + ' and then runs \"rush update\". If no version is specified, a version will be automatically detected (typically'\r\n      + ' either the latest version or a version that won\\'t break the \"ensureConsistentVersions\" policy). If a version'\r\n      + ' range is specified, the latest version in the range will be used. The version will be automatically prepended'\r\n      + ' with a tilde, unless the \"--exact\" or \"--caret\" flags are used. The \"--make-consistent\" flag can be used to'\r\n      + ' update all packages with the dependency.'\r\n    ];\r\n    super({\r\n      actionName: 'add',\r\n      summary: 'Adds a dependency to the package.json and runs rush upgrade.',\r\n      documentation: documentation.join(os.EOL),\r\n      safeForSimultaneousRushProcesses: false,\r\n      parser\r\n    });\r\n  }\r\n\r\n  public onDefineParameters(): void {\r\n    this._packageName = this.defineStringParameter({\r\n      parameterLongName: '--package',\r\n      parameterShortName: '-p',\r\n      required: true,\r\n      argumentName: 'PACKAGE',\r\n      description: '(Required) The name of the package which should be added as a dependency.'\r\n        + ' A SemVer version specifier can be appended after an \"@\" sign.  WARNING: Symbol characters'\r\n        + ' are usually interpreted by your shell, so it\\'s recommended to use quotes.'\r\n        + ' For example, write \"rush add --project \"example@^1.2.3\"\" instead of \"rush add --project example@^1.2.3\".'\r\n    });\r\n    this._exactFlag = this.defineFlagParameter({\r\n      parameterLongName: '--exact',\r\n      description: 'If specified, the SemVer specifier added to the'\r\n        + ' package.json will be an exact version (e.g. without tilde or caret).'\r\n    });\r\n    this._caretFlag = this.defineFlagParameter({\r\n      parameterLongName: '--caret',\r\n      description: 'If specified, the SemVer specifier added to the'\r\n        + ' package.json will be a prepended with a \"caret\" specifier (\"^\").'\r\n    });\r\n    this._devDependencyFlag = this.defineFlagParameter({\r\n      parameterLongName: '--dev',\r\n      description: 'If specified, the package will be added to the \"devDependencies\" section of'\r\n        + ' the package.json'\r\n    });\r\n    this._makeConsistentFlag = this.defineFlagParameter({\r\n      parameterLongName: '--make-consistent',\r\n      parameterShortName: '-m',\r\n      description: 'If specified, other packages with this dependency will have their package.json'\r\n        + ' files updated to use the same version of the dependency.'\r\n    });\r\n    this._skipUpdateFlag = this.defineFlagParameter({\r\n      parameterLongName: '--skip-update',\r\n      parameterShortName: '-s',\r\n      description: 'If specified, the \"rush update\" command will not be run after updating the'\r\n        + ' package.json files.'\r\n    });\r\n  }\r\n\r\n  public run(): Promise<void> {\r\n    const project: RushConfigurationProject | undefined\r\n      = this.rushConfiguration.tryGetProjectForPath(process.cwd());\r\n\r\n    if (!project) {\r\n      return Promise.reject(new Error('The \"rush add\" command must be invoked under a project'\r\n        + ' folder that is registered in rush.json.'));\r\n    }\r\n\r\n    if (this._caretFlag.value && this._exactFlag.value) {\r\n      return Promise.reject(new Error('Only one of \"--caret\" and \"--exact\" should be specified'));\r\n    }\r\n\r\n    let version: string | undefined = undefined;\r\n    let packageName: string | undefined = this._packageName.value!;\r\n    const parts: Array<string> = packageName.split('@');\r\n\r\n    if (parts[0] === '') {\r\n      // this is a scoped package\r\n      packageName = '@' + parts[1];\r\n      version = parts[2];\r\n    } else {\r\n      packageName = parts[0];\r\n      version = parts[1];\r\n    }\r\n\r\n    if (!PackageName.isValidName(packageName)) {\r\n      return Promise.reject(new Error(`The package name \"${packageName}\" is not valid.`));\r\n    }\r\n\r\n    if (version && version !== 'latest' && !semver.validRange(version) && !semver.valid(version)) {\r\n      return Promise.reject(new Error(`The SemVer specifier \"${version}\" is not valid.`));\r\n    }\r\n\r\n    return new PackageJsonUpdater(this.rushConfiguration, this.rushGlobalFolder).doRushAdd({\r\n      currentProject: project,\r\n      packageName: packageName,\r\n      initialVersion: version,\r\n      devDependency: this._devDependencyFlag.value,\r\n      updateOtherPackages: this._makeConsistentFlag.value,\r\n      skipUpdate: this._skipUpdateFlag.value,\r\n      debugInstall: this.parser.isDebug,\r\n      rangeStyle: this._caretFlag.value ? SemVerStyle.Caret\r\n        : (this._exactFlag.value ? SemVerStyle.Exact : SemVerStyle.Tilde)\r\n    });\r\n  }\r\n}\r\n"]}