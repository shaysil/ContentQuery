{"version":3,"file":"ChangeAction.js","sourceRoot":"","sources":["../../../src/cli/actions/ChangeAction.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\r\n// See LICENSE in the project root for license information.\r\n\r\nimport * as os from 'os';\r\nimport * as path from 'path';\r\nimport * as child_process from 'child_process';\r\nimport * as colors from 'colors';\r\n\r\nimport inquirer = require('inquirer');\r\n\r\nimport {\r\n  CommandLineFlagParameter,\r\n  CommandLineStringParameter\r\n} from '@microsoft/ts-command-line';\r\nimport { FileSystem } from '@microsoft/node-core-library';\r\n\r\nimport { RushConfigurationProject } from '../../api/RushConfigurationProject';\r\nimport {\r\n  IChangeFile,\r\n  IChangeInfo\r\n} from '../../api/ChangeManagement';\r\nimport { VersionControl } from '../../utilities/VersionControl';\r\nimport { ChangeFile } from '../../api/ChangeFile';\r\nimport { BaseRushAction } from './BaseRushAction';\r\nimport { RushCommandLineParser } from '../RushCommandLineParser';\r\nimport { ChangeFiles } from '../../logic/ChangeFiles';\r\nimport {\r\n  VersionPolicy,\r\n  IndividualVersionPolicy,\r\n  LockStepVersionPolicy,\r\n  VersionPolicyDefinitionName\r\n} from '../../api/VersionPolicy';\r\n\r\nexport class ChangeAction extends BaseRushAction {\r\n  private _sortedProjectList: string[];\r\n  private _changeFileData: Map<string, IChangeFile>;\r\n  private _changeComments: Map<string, string[]>;\r\n  private _verifyParameter: CommandLineFlagParameter;\r\n  private _targetBranchParameter: CommandLineStringParameter;\r\n  private _targetBranchName: string;\r\n  private _projectHostMap: Map<string, string>;\r\n\r\n  private _prompt: inquirer.PromptModule;\r\n\r\n  constructor(parser: RushCommandLineParser) {\r\n    const documentation: string[] = [\r\n      'Asks a series of questions and then generates a <branchname>-<timstamp>.json file ' +\r\n      'in the common folder. The `publish` command will consume these files and perform the proper ' +\r\n      'version bumps. Note these changes will eventually be published in a changelog.md file in each package.',\r\n      '',\r\n      'The possible types of changes are: ',\r\n      '',\r\n      'MAJOR - these are breaking changes that are not backwards compatible. ' +\r\n      'Examples are: renaming a public class, adding/removing a non-optional ' +\r\n      'parameter from a public API, or renaming an variable or function that ' +\r\n      'is exported.',\r\n      '',\r\n      'MINOR - these are changes that are backwards compatible (but not ' +\r\n      'forwards compatible). Examples are: adding a new public API or adding an ' +\r\n      'optional parameter to a public API',\r\n      '',\r\n      'PATCH - these are changes that are backwards and forwards compatible. ' +\r\n      'Examples are: Modifying a private API or fixing a bug in the logic ' +\r\n      'of how an existing API works.',\r\n      '',\r\n      'HOTFIX (EXPERIMENTAL) - these are changes that are hotfixes targeting a ' +\r\n      'specific older version of the package. When a hotfix change is added, ' +\r\n      'other changes will not be able to increment the version number.' +\r\n      'Enable this feature by setting \\'hotfixChangeEnabled\\' in your rush.json.',\r\n      ''\r\n    ];\r\n    super({\r\n      actionName: 'change',\r\n      summary: 'Records changes made to projects, indicating how the package version number should be bumped ' +\r\n        'for the next publish.',\r\n      documentation: documentation.join(os.EOL),\r\n      safeForSimultaneousRushProcesses: true,\r\n      parser\r\n    });\r\n  }\r\n\r\n  public onDefineParameters(): void {\r\n    this._verifyParameter = this.defineFlagParameter({\r\n      parameterLongName: '--verify',\r\n      parameterShortName: '-v',\r\n      description: 'Verify the change file has been generated and that it is a valid JSON file'\r\n    });\r\n    this._targetBranchParameter = this.defineStringParameter({\r\n      parameterLongName: '--target-branch',\r\n      parameterShortName: '-b',\r\n      argumentName: 'BRANCH',\r\n      description: 'If this parameter is specified, compare current branch with the target branch to get changes. ' +\r\n        'If this parameter is not specified, the current branch is compared against the \"master\" branch.'\r\n    });\r\n  }\r\n\r\n  public run(): Promise<void> {\r\n    console.log(`Target branch is ${this._targetBranch}`);\r\n    this._projectHostMap = this._generateHostMap();\r\n\r\n    if (this._verifyParameter.value) {\r\n      this._verify();\r\n      return Promise.resolve();\r\n    }\r\n    this._sortedProjectList = this._getChangedPackageNames()\r\n      .sort();\r\n\r\n    if (this._sortedProjectList.length === 0) {\r\n      console.log('No change file is needed.');\r\n      this._warnUncommittedChanges();\r\n      return Promise.resolve();\r\n    }\r\n\r\n    this._prompt = inquirer.createPromptModule();\r\n    this._changeFileData = new Map<string, IChangeFile>();\r\n    this._changeComments = ChangeFiles.getChangeComments(this._getChangeFiles());\r\n\r\n    return this._promptLoop()\r\n      .catch((error: Error) => {\r\n        throw new Error(`There was an error creating the change file: ${error.toString()}`);\r\n      });\r\n  }\r\n\r\n  private _generateHostMap(): Map<string, string> {\r\n    const hostMap: Map<string, string> = new Map<string, string>();\r\n    this.rushConfiguration.projects.forEach(project => {\r\n      let hostProjectName: string = project.packageName;\r\n      if (project.versionPolicy && project.versionPolicy.isLockstepped) {\r\n        const lockstepPolicy: LockStepVersionPolicy = project.versionPolicy as LockStepVersionPolicy;\r\n        hostProjectName = lockstepPolicy.mainProject || project.packageName;\r\n      }\r\n      hostMap.set(project.packageName, hostProjectName);\r\n    });\r\n    return hostMap;\r\n  }\r\n\r\n  private _verify(): void {\r\n    const changedPackages: string[] = this._getChangedPackageNames();\r\n\r\n    if (changedPackages.length > 0) {\r\n      this._validateChangeFile(changedPackages);\r\n    } else {\r\n      console.log('No change is needed.');\r\n    }\r\n  }\r\n\r\n  private get _targetBranch(): string {\r\n    if (!this._targetBranchName) {\r\n      this._targetBranchName = this._targetBranchParameter.value ||\r\n        VersionControl.getRemoteMasterBranch(this.rushConfiguration.repositoryUrl);\r\n    }\r\n    return this._targetBranchName;\r\n  }\r\n\r\n  private _getChangedPackageNames(): string[] {\r\n    const changedFolders: Array<string | undefined> | undefined = VersionControl.getChangedFolders(this._targetBranch);\r\n    if (!changedFolders) {\r\n      return [];\r\n    }\r\n    const changedPackageNames: Set<string> = new Set<string>();\r\n\r\n    this.rushConfiguration.projects\r\n    .filter(project => project.shouldPublish)\r\n    .filter(project => this._hasProjectChanged(changedFolders, project))\r\n    .forEach(project => {\r\n      const hostName: string | undefined = this._projectHostMap.get(project.packageName);\r\n      if (hostName) {\r\n        changedPackageNames.add(hostName);\r\n      }\r\n    });\r\n    return [...changedPackageNames];\r\n  }\r\n\r\n  private _validateChangeFile(changedPackages: string[]): void {\r\n    const files: string[] = this._getChangeFiles();\r\n    if (files.length === 0) {\r\n      throw new Error(`No change file is found. Run \"rush change\" to generate a change file.`);\r\n    }\r\n    ChangeFiles.validate(files, changedPackages);\r\n  }\r\n\r\n  private _getChangeFiles(): string[] {\r\n    return VersionControl.getChangedFiles(`common/changes/`, this._targetBranch).map(relativePath => {\r\n      return path.join(this.rushConfiguration.rushJsonFolder, relativePath);\r\n    });\r\n  }\r\n\r\n  private _hasProjectChanged(changedFolders: Array<string | undefined>,\r\n    project: RushConfigurationProject): boolean {\r\n    let normalizedFolder: string = project.projectRelativeFolder;\r\n    if (normalizedFolder.charAt(normalizedFolder.length - 1) !== '/') {\r\n      normalizedFolder = normalizedFolder + '/';\r\n    }\r\n    const pathRegex: RegExp = new RegExp(`^${normalizedFolder}`, 'i');\r\n    for (const folder of changedFolders) {\r\n      if (folder && folder.match(pathRegex)) {\r\n        return true;\r\n      }\r\n    }\r\n    return false;\r\n  }\r\n\r\n  /**\r\n   * The main loop which continually asks user for questions about changes until they don't\r\n   * have any more, at which point we collect their email and write the change file.\r\n   */\r\n  private _promptLoop(): Promise<void> {\r\n    // If there are still projects, ask about the next one\r\n    if (this._sortedProjectList.length) {\r\n      return this._askQuestions(this._sortedProjectList.pop()!)\r\n        .then((answers: IChangeInfo) => {\r\n          if (answers) {\r\n            // Save the info into the changefile\r\n            let changeFile: IChangeFile | undefined = this._changeFileData.get(answers.packageName);\r\n            if (!changeFile) {\r\n              changeFile = {\r\n                changes: [],\r\n                packageName: answers.packageName,\r\n                email: undefined\r\n              };\r\n              this._changeFileData.set(answers.packageName, changeFile!);\r\n            }\r\n            changeFile!.changes.push(answers);\r\n          }\r\n          // Continue to loop\r\n          return this._promptLoop();\r\n\r\n        });\r\n    } else {\r\n      this._warnUncommittedChanges();\r\n      // We are done, collect their email\r\n      return this._detectOrAskForEmail().then((email: string) => {\r\n        this._changeFileData.forEach((changeFile: IChangeFile) => {\r\n          changeFile.email = email;\r\n        });\r\n\r\n        this._writeChangeFiles();\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Asks all questions which are needed to generate changelist for a project.\r\n   */\r\n  private _askQuestions(packageName: string): Promise<IChangeInfo | undefined> {\r\n    console.log(`${os.EOL}${packageName}`);\r\n    const comments: string[] | undefined = this._changeComments.get(packageName);\r\n    if (comments) {\r\n      console.log(`Found existing comments:`);\r\n      comments.forEach(comment => {\r\n        console.log(`    > ${comment}`);\r\n      });\r\n      return this._prompt({\r\n        name: 'appendComment',\r\n        type: 'list',\r\n        default: 'skip',\r\n        message: 'Append to existing comments or skip?',\r\n        choices: [\r\n          {\r\n            'name': 'Skip',\r\n            'value': 'skip'\r\n          },\r\n          {\r\n            'name': 'Append',\r\n            'value': 'append'\r\n          }\r\n        ]\r\n      })\r\n      .then(({ appendComment }: { appendComment: 'skip' | 'append' }) => {\r\n        if (appendComment === 'skip') {\r\n          return undefined;\r\n        } else {\r\n          return this._promptForComments(packageName);\r\n        }\r\n      });\r\n    } else {\r\n      return this._promptForComments(packageName);\r\n    }\r\n  }\r\n\r\n  private _promptForComments(packageName: string): Promise<IChangeInfo | undefined> {\r\n    const bumpOptions: { [type: string]: string } = this._getBumpOptions(packageName);\r\n    return this._prompt({\r\n      name: 'comment',\r\n      type: 'input',\r\n      message: `Describe changes, or ENTER if no changes:`\r\n    })\r\n    .then(({ comment }: { comment: string }) => {\r\n      if (Object.keys(bumpOptions).length === 0 || !comment) {\r\n        return {\r\n          comment: comment || '',\r\n          packageName: packageName,\r\n          type: 'none'\r\n        } as IChangeInfo;\r\n      } else {\r\n        return this._prompt({\r\n          choices: Object.keys(bumpOptions).map(option => {\r\n            return {\r\n              'value': option,\r\n              'name': bumpOptions[option]\r\n            };\r\n          }),\r\n          default: 'patch',\r\n          message: 'Select the type of change:',\r\n          name: 'bumpType',\r\n          type: 'list'\r\n        }).then(({ bumpType }: { bumpType: string }) => {\r\n          return {\r\n            packageName: packageName,\r\n            comment: comment,\r\n            type: bumpType\r\n          } as IChangeInfo;\r\n        });\r\n      }\r\n    });\r\n  }\r\n\r\n  private _getBumpOptions(packageName: string): {[type: string]: string } {\r\n    const project: RushConfigurationProject | undefined = this.rushConfiguration.getProjectByName(packageName);\r\n    const versionPolicy: VersionPolicy | undefined = project!.versionPolicy;\r\n\r\n    let bumpOptions: { [type: string]: string } = {\r\n      'major': 'major - for changes that break compatibility, e.g. removing an API',\r\n      'minor': 'minor - for backwards compatible changes, e.g. adding a new API',\r\n      'patch': 'patch - for changes that do not affect compatibility, e.g. fixing a bug'\r\n    };\r\n\r\n    if (this.rushConfiguration.hotfixChangeEnabled) {\r\n      // tslint:disable-next-line:no-string-literal\r\n      bumpOptions['hotfix'] = 'hotfix - for changes that need to be published in a separate hotfix package';\r\n    }\r\n\r\n    if (versionPolicy) {\r\n      if (versionPolicy.definitionName === VersionPolicyDefinitionName.lockStepVersion) {\r\n        // No need to ask for bump types if project is lockstep versioned.\r\n        bumpOptions = {};\r\n      } else if (versionPolicy.definitionName === VersionPolicyDefinitionName.individualVersion) {\r\n        const individualPolicy: IndividualVersionPolicy = versionPolicy as IndividualVersionPolicy;\r\n        if (individualPolicy.lockedMajor !== undefined) {\r\n          // tslint:disable-next-line:no-string-literal\r\n          delete bumpOptions['major'];\r\n        }\r\n      }\r\n    }\r\n    return bumpOptions;\r\n  }\r\n\r\n  /**\r\n   * Will determine a user's email by first detecting it from their git config,\r\n   * or will ask for it if it is not found or the git config is wrong.\r\n   */\r\n  private _detectOrAskForEmail(): Promise<string> {\r\n    return this._detectAndConfirmEmail().then((email: string) => {\r\n\r\n      if (email) {\r\n        return Promise.resolve(email);\r\n      } else {\r\n        return this._promptForEmail();\r\n      }\r\n\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Detects the user's email address from their git configuration, prompts the user to approve the\r\n   * detected email. It returns undefined if it cannot be detected.\r\n   */\r\n  private _detectAndConfirmEmail(): Promise<string | undefined> {\r\n    let email: string | undefined;\r\n    try {\r\n      email = child_process.execSync('git config user.email')\r\n        .toString()\r\n        .replace(/(\\r\\n|\\n|\\r)/gm, '');\r\n    } catch (err) {\r\n      console.log('There was an issue detecting your Git email...');\r\n      email = undefined;\r\n    }\r\n\r\n    if (email) {\r\n      return this._prompt([\r\n        {\r\n          type: 'confirm',\r\n          name: 'isCorrectEmail',\r\n          default: 'Y',\r\n          message: `Is your email address ${email} ?`\r\n        }\r\n      ]).then(({ isCorrectEmail }: { isCorrectEmail: boolean }) => {\r\n        return isCorrectEmail ? email : undefined;\r\n      });\r\n    } else {\r\n      return Promise.resolve(undefined);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Asks the user for their email address\r\n   */\r\n  private _promptForEmail(): Promise<string> {\r\n    return this._prompt([\r\n      {\r\n        type: 'input',\r\n        name: 'email',\r\n        message: 'What is your email address?',\r\n        validate: (input: string) => {\r\n          return true; // @todo should be an email\r\n        }\r\n      }\r\n    ])\r\n      .then(({ email }) => {\r\n        return email;\r\n      });\r\n  }\r\n\r\n  private _warnUncommittedChanges(): void {\r\n    try {\r\n      if (VersionControl.hasUncommittedChanges()) {\r\n        console.log(os.EOL +\r\n          colors.yellow('Warning: You have uncommitted changes, which do not trigger a change entry.'));\r\n      }\r\n    } catch (error) {\r\n      console.log('Ignore the failure of checking uncommitted changes');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Writes changefile to the common/changes folder. Will prompt for overwrite if file already exists.\r\n   */\r\n  private _writeChangeFiles(): void {\r\n    this._changeFileData.forEach((changeFile: IChangeFile) => {\r\n      this._writeChangeFile(changeFile);\r\n    });\r\n  }\r\n\r\n  private _writeChangeFile(changeFileData: IChangeFile): void {\r\n    const output: string = JSON.stringify(changeFileData, undefined, 2);\r\n    const changeFile: ChangeFile = new ChangeFile(changeFileData, this.rushConfiguration);\r\n    const filePath: string = changeFile.generatePath();\r\n\r\n    if (FileSystem.exists(filePath)) {\r\n      // prompt about overwrite\r\n      this._prompt([\r\n        {\r\n          name: 'overwrite',\r\n          type: 'confirm',\r\n          message: `Overwrite ${filePath} ?`\r\n        }\r\n      ]).then(({ overwrite }: { overwrite: string }) => {\r\n        if (overwrite) {\r\n          return this._writeFile(filePath, output);\r\n        } else {\r\n          console.log(`Not overwriting ${filePath}...`);\r\n          return Promise.resolve();\r\n        }\r\n      });\r\n    }\r\n\r\n    this._writeFile(filePath, output);\r\n  }\r\n\r\n  /**\r\n   * Writes a file to disk, ensuring the directory structure up to that point exists\r\n   */\r\n  private _writeFile(fileName: string, output: string): void {\r\n    FileSystem.writeFile(fileName, output, {\r\n      ensureFolderExists: true\r\n    });\r\n    console.log('Created file: ' + fileName);\r\n  }\r\n}\r\n"]}